<script>
  const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';
  const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';

  const audio = document.getElementById('audio');
  const title = document.getElementById('track-title');
  const trackListDiv = document.getElementById('track-list');
  const searchInput = document.getElementById('search');

  let tracks = [];
  let filteredTracks = [];
  let currentTrack = 0;

  function playTrack(index) {
    const track = filteredTracks[index];
    if (!track) return;
    currentTrack = index;
    const url = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;
    audio.src = url;
    title.textContent = track.name;
    audio.play();
    highlightCurrentTrack();
  }

  function nextTrack() {
    currentTrack = (currentTrack + 1) % filteredTracks.length;
    playTrack(currentTrack);
  }

  function prevTrack() {
    currentTrack = (currentTrack - 1 + filteredTracks.length) % filteredTracks.length;
    playTrack(currentTrack);
  }

  function shuffleTrack() {
    const randomIndex = Math.floor(Math.random() * filteredTracks.length);
    playTrack(randomIndex);
  }

  function renderTrackList() {
    trackListDiv.innerHTML = '';
    filteredTracks.forEach((track, index) => {
      const div = document.createElement('div');
      div.className = 'track-item';
      div.textContent = track.name;
      div.onclick = () => playTrack(index);
      trackListDiv.appendChild(div);
    });
    highlightCurrentTrack();
  }

  function highlightCurrentTrack() {
    const items = document.querySelectorAll('.track-item');
    items.forEach((el, i) => {
      el.classList.toggle('active', i === currentTrack);
    });
  }

  async function loadAllTracks() {
    let pageToken = '';
    let allFiles = [];

    try {
      do {
        const query = encodeURIComponent(`'${folderId}' in parents and (mimeType='audio/mpeg' or mimeType='audio/mp4' or mimeType='audio/x-wav')`);
        const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,mimeType),nextPageToken&pageSize=100&key=${apiKey}${pageToken ? `&pageToken=${pageToken}` : ''}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.files && data.files.length > 0) {
          allFiles = allFiles.concat(data.files);
        }

        pageToken = data.nextPageToken;
      } while (pageToken);

      tracks = allFiles;
      filteredTracks = tracks;
      renderTrackList();
      playTrack(0);
    } catch (err) {
      title.textContent = 'Failed to load tracks.';
      console.error(err);
    }
  }

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    filteredTracks = tracks.filter(track =>
      track.name.toLowerCase().includes(query)
    );
    renderTrackList();
    currentTrack = 0;
    if (filteredTracks.length > 0) {
      playTrack(0);
    } else {
      audio.pause();
      title.textContent = 'No results found.';
    }
  });

  audio.addEventListener('ended', nextTrack);
  loadAllTracks();
</script>
